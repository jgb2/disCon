---
title: "DisCon Kids Pilot"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(jsonlite)
library(tidyr)
library(stringr)
library(dplyr)
library(ggthemes)
library(langcog)

library(lsr)
library(pwr)

```

```{r data pre-processing}

files <- dir("../../kids_simple_4cat/")
#files <- dir("../../kids_raw_data/600/")

raw_data <- data_frame()
for (f in files) {
  jf <- paste("../../kids_simple_4cat/",f,sep="")
#  jf <- paste("../../kids_raw_data/600/",f,sep="")
  jd <- fromJSON(paste(readLines(jf), collapse=""))
  id <- as_data_frame(jd$data$data)
  raw_data <- bind_rows(raw_data, id)
}

data_4cat <- raw_data %>%
  mutate(distribution = as.character(distribution),
         distribution = factor(distribution, levels = c("c(6, 0, 0)", "c(4, 2, 0)", "c(2, 2, 2)")))

files <- dir("../../kids_simple/")

raw_data <- data_frame()
for (f in files) {
  jf <- paste("../../kids_simple/",f,sep="")
  jd <- fromJSON(paste(readLines(jf), collapse=""))
  id <- as_data_frame(jd$data$data)
  raw_data <- bind_rows(raw_data, id)
}

data_6cat <- raw_data %>%
  mutate(distribution = as.character(distribution),
         distribution = factor(distribution, levels = c("c(6, 0, 0)", "c(4, 2, 0)", "c(2, 2, 2)"))) %>%
  filter(target1 != "furniture", target1 != "instruments")

data <- bind_rows(data_4cat, data_6cat)

write.csv(data, file="../data/kids_4cat_pilot.data.csv")

data <- read_csv(file="../data/kids_4cat_pilot.data.csv")
```

```{r sanity checks}
data <- data %>% 
  filter(subid != "", subid != "test", subid != "Test")

data %>%
  filter(phase == 'training') %>%
  group_by(subid) %>%
  summarise(correct = mean(correct_item))

drop <- data %>%
  filter(phase == 'training') %>%
  group_by(subid) %>%
  summarise(correct = mean(correct_item)) %>%
  filter(correct < 0.83) %>%
  pull(subid)

data %>%
  filter(!subid %in% drop) %>%
  group_by(subage) %>%
  summarise(n = length(unique(subid)))

```

# Do proportion of choices match the frequency in the distribution

```{r proportion of choices}
plot1 <- data %>%
  filter(phase == 'test') %>%
  group_by(distribution, subid) %>%
  summarise(correct = mean(correct_target1),
            correct2 = mean(correct_target2),
            correct3 = mean(correct_target3)) %>%
  gather(item, prop_correct, -distribution, -subid) %>%
  group_by(distribution, item) %>%
  multi_boot_standard(col = "prop_correct")


ggplot(plot1,
       aes(x = item, y=mean, fill=item)) +
  geom_bar(stat='identity') +
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper)) +
  scale_fill_solarized(name = "Chosen item",
                       breaks = c("correct", "correct2", "correct3"),
                       labels = c("most frequent", "second most frequent", "least frequent"))+
  facet_grid(~distribution, 
             labeller = as_labeller(c(`c(6, 0, 0)` = "Distribution\n(6-0-0)", `c(4, 2, 0)` = "Distribution\n(4-2-0)", `c(2, 2, 2)` = "Distribution\n(2-2-2)", preference = "preference", statistical = "statistical"))) +
  geom_hline(yintercept = 1/3, lty=2) +
  ylim(0, 1) +
  theme_few() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x="", y= "proportion chosen")
```

# How does the last item seen affect the object chosen in the anaphora case? 
```{r last item}
plot2 <- data %>%
  filter(phase == "test", distribution != "c(6, 0, 0)") %>%
  mutate(trackLast = ifelse(lastInputCat == target1, "yes", "no")) %>%
  group_by (distribution, subid) %>%
  summarise (lastInput = mean(same_lastInput),
             n = n()) %>% 
  multi_boot_standard(col = "lastInput")
  
ggplot(plot2,
       aes(x = distribution, y = mean, fill = distribution)) +
  geom_bar(stat='identity', width = 0.3) +
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper)) +
  geom_hline(yintercept = 1/3, lty=2) +
  ylim(0, 1) +
  theme_few()
```

# Are participants choosing the middle item more? 
```{r middle item}
plot3 <- data %>%
  filter(phase == 'test') %>%
  mutate(pick_l = ifelse(pickPos == "item_l", 1, 0), 
         pick_m = ifelse(pickPos == "item_m", 1, 0),
         pick_r = ifelse(pickPos == "item_r", 1, 0)) %>%
  group_by(distribution, subid) %>%
  summarise(choose_l = mean(pick_l),
            choose_m = mean(pick_m),
            choose_r = mean(pick_r)) %>%
  gather(item, prop_choose, -distribution, -subid) %>%
  group_by(distribution, item) %>%
  multi_boot_standard(col = "prop_choose")
  
ggplot(plot3,
       aes(x = item, y=mean, fill=item)) +
  geom_bar(stat='identity') +
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper)) +
  scale_fill_solarized(name = "Chosen item",
                       breaks = c("choose_l", "choose_m", "choose_r"),
                       labels = c("left", "middle", "right"))+
  facet_grid(~distribution, 
             labeller = as_labeller(c(`c(6, 0, 0)` = "Distribution\n(6-0-0)", `c(4, 2, 0)` = "Distribution\n(4-2-0)", `c(2, 2, 2)` = "Distribution\n(2-2-2)"))) +
  geom_hline(yintercept = 1/3, lty=2) +
  ylim(0, 1) +
  theme_few() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x="", y= "proportion chosen")
```

# Are participants choosing the middle item even when the middle item is wrong? 
```{r middle item, chose incorrectly}
plot4 <- data %>%
  filter(phase == 'test', correct_target1 == 0) %>%
  mutate(pick_l = ifelse(pickPos == "item_l", 1, 0), 
         pick_m = ifelse(pickPos == "item_m", 1, 0),
         pick_r = ifelse(pickPos == "item_r", 1, 0)) %>%
  group_by(distribution, subid) %>%
  summarise(choose_l = mean(pick_l),
            choose_m = mean(pick_m),
            choose_r = mean(pick_r)) %>%
  gather(item, prop_choose, -distribution, -subid) %>%
  group_by(distribution, item) %>%
  multi_boot_standard(col = "prop_choose")
  
ggplot(plot4,
       aes(x = item, y=mean, fill=item)) +
  geom_bar(stat='identity') +
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper)) +
  scale_fill_solarized(name = "Chosen item",
                       breaks = c("choose_l", "choose_m", "choose_r"),
                       labels = c("left", "middle", "right"))+
  facet_grid(~distribution, 
             labeller = as_labeller(c(`c(6, 0, 0)` = "Distribution\n(6-0-0)", `c(4, 2, 0)` = "Distribution\n(4-2-0)", `c(2, 2, 2)` = "Distribution\n(2-2-2)"))) +
  geom_hline(yintercept = 1/3, lty=2) +
  ylim(0, 1) +
  theme_few() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x="", y= "proportion chosen")
```

```{r plot2, fig.width = 8, echo=FALSE, warning = FALSE}
plot2 <- data %>%
  filter(phase == 'test') %>%
  group_by(distribution, subid, subage) %>%
  summarise(correct = mean(correct_target1),
            correct2 = mean(correct_target2),
            correct3 = mean(correct_target3)) %>%
  gather(item, prop_correct, -distribution, -subid, -subage) %>%
  group_by(distribution, item, subage) %>%
  multi_boot_standard(col = "prop_correct")

ggplot(plot2,
       aes(x = item, y=mean, fill=item)) +
  geom_bar(stat='identity') +
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper)) +
  scale_fill_solarized(name = "Chosen item",
                       breaks = c("correct", "correct2", "correct3"),
                       labels = c("most frequent", "second most frequent", "least frequent"))+
  facet_grid(distribution~subage, 
             labeller = as_labeller(c(`c(6, 0, 0)` = "Distribution\n(6-0-0)", `c(4, 2, 0)` = "Distribution\n(4-2-0)", `c(2, 2, 2)` = "Distribution\n(2-2-2)", `2` = "2", `3` = "3", `4` = "4"))) +
  geom_hline(yintercept = 1/3, lty=2) +
  ylim(0, 1) +
  theme_few() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x="", y= "proportion chosen")
```

```{r plot5, echo=FALSE, warning = FALSE, cache = TRUE}

plot5 <- data %>%
  filter(phase == 'test') %>%
  group_by(distribution, subid, target1) %>%
  summarise(correct = mean(correct_target1)) %>%
  gather(item, prop_correct, -distribution, -subid, -target1) %>%
  group_by(distribution, item, target1) %>%
  multi_boot_standard(col = "prop_correct")

ggplot(plot5,
       aes(x = target1, y=mean, fill=item)) +
  geom_bar(stat='identity') +
 # geom_linerange(aes(ymin = ci_lower, ymax = ci_upper)) +
  scale_fill_solarized()+
  guides(fill = F) +
  geom_hline(yintercept = 1/3, lty=2) +
  ylim(0, 1) +
  theme_few() +
  labs(x="category", y= "proportion chosen")
```

``` {r power analysis}
power <- data %>%
  filter(phase == 'test') %>%
  group_by(subid) %>%
  summarise(correct = mean(correct_target1))

t.test(power$correct, mu = 1/3)

cohensD(power$correct, mu = 1/3)

pwr.t.test(d = 0.5127475, sig.level = 0.05, power = .8, type = c("one.sample"))
```

# 2yo in 600

```{r data pre-processing, include = F}

#files <- dir("../../kids_simple_4cat/")
files <- dir("../../kids_raw_data/pilot/600/")

raw_data <- data_frame()
for (f in files) {
#  jf <- paste("../../kids_simple_4cat/",f,sep="")
  jf <- paste("../../kids_raw_data/pilot/600/",f,sep="")
  jd <- fromJSON(paste(readLines(jf), collapse=""))
  date <- str_sub(jf,36,str_length(jf)-11)
  id <- as_data_frame(jd$data$data)%>% mutate(test_date = date)
  raw_data <- bind_rows(raw_data, id)
}


```


```{r proportion of choices}
pos_plot <- raw_data %>%
  filter(phase == 'test')%>%
  group_by(pickPos,subid) %>%
  summarise(n = n())


pos_plot2 <- pos_plot%>%
  group_by(pickPos)%>%
  multi_boot_standard(col = "n")

ggplot() +
  geom_jitter(data = pos_plot, aes(x = pickPos, y = n, col = subid),size = 2, height = 0, alpha = 1)+
  geom_hline(yintercept = 4/3, lty=2)+
  geom_pointrange(data = pos_plot2, aes(x = pickPos, y = mean,  ymin = ci_lower, ymax = ci_upper),size = .8)+
  labs(x="Item position",y="Mean number of times item was chosen")+
  theme_few() +
  ylim(0,4)+
  guides(alpha = F)+
  scale_color_ptol()
```

```{r}
p1 <- raw_data %>%
  filter(phase == 'test')%>%
  group_by(experiment,subid) %>%
  summarise(correct = mean(correct_target1)) 

p2 <- p1 %>%
  group_by(experiment) %>%
  multi_boot_standard(col = "correct")


ggplot() +
  geom_jitter(data = p1, aes(x = experiment, y = correct,  alpha = .2),width = .2,height = .01)+
  geom_pointrange(data = p2, aes(x = experiment, y = mean,  ymin = ci_lower, ymax = ci_upper),size = .8)+
  geom_hline(yintercept = 1/3, lty=2)+
  labs(x="",y="Proportion correct")+
  theme_few() +
  ylim(-0.05,1.05)+
  guides(alpha = F)+
  scale_color_solarized()
```














